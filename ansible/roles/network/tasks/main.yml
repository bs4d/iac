---
# wifi connection
- name: get the wifi interface name
  set_fact:
    wifi_interface: >-
      {{ ansible_facts.interfaces |
        select('match', '^w') |
        list |
        first }}
- name: create the home wifi connection
  nmcli:
    state: present
    conn_name: home
    ifname: "{{ wifi_interface }}"
    type: wifi
    ssid: "{{ home_wifi.ssid }}"
    wifi_sec:
      key-mgmt: wpa-psk
      psk: "{{ home_wifi.psk }}"
- name: bring up the home wifi connection
  nmcli:
    state: up
    conn_name: home
- name: wait for internet access
  wait_for:
    host: 1.1.1.1
    port: 53
    timeout: 30

- name: install network packages
  become: true
  package:
    state: present
    name:
    - ufw
    - openssh
    - sshpass

# firewall
- name: enable ufw
  become: true
  ufw:
    state: enabled
    default: deny

# ssh key
- name: create the user ssh key
  user:
    name: "{{ ansible_env.USER }}"
    generate_ssh_key: true
    ssh_key_type: ed25519
- name: add the user ssh key to home server authorized keys
  delegate_to: "{{ home_server.ip }}"
  vars:
    ansible_user: "{{ home_server.user }}"
    ansible_ssh_pass: "{{ home_server.password }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
  copy:
    src: "{{ lookup('env', 'HOME') }}/.ssh/id_ed25519.pub"
    dest: "/home/{{ ansible_user }}/.ssh/authorized_keys"

# /etc/hosts
- name: add a host entry for the home server
  become: true
  lineinfile:
    path: /etc/hosts
    regexp: ^.*\s{{ home_server.hostname }}$
    line: "{{ home_server.ip }} {{ home_server.hostname }}"
