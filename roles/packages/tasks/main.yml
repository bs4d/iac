---
# system
- name: run system update on the home server
  when: inventory_hostname == "home_server"
  become: true
  apt:
    update_cache: true
    upgrade: dist
- name: run system update on pc
  when: inventory_hostname == "pc"
  become: true
  pacman:
    update_cache: true
    upgrade: true
  register: upgrade
  changed_when: upgrade.packages is defined
- name: install target system packages
  become: true
  package:
    state: present
    name: "{{ package_list.system.values() | list | flatten }}"

- name: skip flatpak and aur packages on the home server
  when: inventory_hostname == "home_server"
  meta: end_role

# flatpak
- name: delete the system flathub remote
  become: true
  flatpak_remote:
    state: absent
    name: flathub
- name: set up the user flathub remote
  flatpak_remote:
    name: flathub
    flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
    method: user
- name: install/update flatpak apps
  flatpak:
    method: user
    state: latest
    name: "{{ package_list.flatpak }}"

# aur
- name: set makepkg config to use doas for privilege escalation
  lineinfile:
    create: true
    path: "{{ ansible_env.HOME }}/.makepkg.conf"
    regex: ^PACMAN_AUTH=.*$
    line: "PACMAN_AUTH=('doas')"
- name: gather aur package facts
  package_facts:
- name: install/update aur packages
  loop: "{{ package_list.aur }}"
  include_tasks: aur-pkg.yml
  vars:
    package_name: "{{ item }}"
